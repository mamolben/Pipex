#include "pipex_bonus.h"

/* ====== Setup de ficheros y here_doc ====== */
static void setup_io(int ac, char **av, int *start_cmd, int *fd_out)
{
    if (ft_strncmp(av[1], "here_doc", 8) == 0)
    {
        if (ac < 6)
        {
            ft_putendl_fd("Usage: ./pipex_bonus here_doc LIMITER cmd1 cmd2 ... outfile", 2);
            exit(1);
        }
        *start_cmd = 3;                 // Primer comando
        *fd_out = open_output_fd(av[ac - 1], 1);
        run_here_doc(av);               // Maneja heredoc y stdin
    }
    else
    {
        if (ac < 5)
        {
            ft_putendl_fd("Usage: ./pipex_bonus infile cmd1 cmd2 ... outfile", 2);
            exit(1);
        }
        *start_cmd = 2;                 // Primer comando
        int fd_in = open_input_fd(av, 0);
        *fd_out = open_output_fd(av[ac - 1], 1);
        dup2(fd_in, STDIN_FILENO);      // Redirige entrada
    }
}

/* ====== Ejecuta todos los comandos intermedios y el último ====== */
static void run_commands(int ac, char **av, char **env, int start_cmd, int fd_out)
{
    int i = start_cmd;

    while (i < ac - 2)
        do_pipe(av[i++], env);          // Ejecuta los comandos en pipe

    dup2(fd_out, STDOUT_FILENO);        // Redirige salida del último comando
    exec(av[ac - 2], env);              // Ejecuta el último comando
}

/* ====== Main ultra limpio ====== */
int main(int ac, char **av, char **env)
{
    int start_cmd, fd_out;

    setup_io(ac, av, &start_cmd, &fd_out);
    run_commands(ac, av, env, start_cmd, fd_out);

    return 0;
}

